{
   "_id": "_design/genbank",
   "_rev": "4-0457fa0ee7697ddb6d8090bb99b13db4",
   "language": "javascript",
   "views": {
       "nt": {
           "map": "/*\n\nShared code\n\n\n*/\n//----------------------------------------------------------------------------------------\n// Store a triple with optional language code\nfunction triple(subject, predicate, object, language) {\n  var triple = [];\n  triple[0] = subject;\n  triple[1] = predicate;\n  triple[2] = object;\n\n  if (typeof language === 'undefined') {} else {\n    triple[3] = language;\n  }\n\n  return triple;\n}\n\n//----------------------------------------------------------------------------------------\n// Store a quad (not used at present)\nfunction quad(subject, predicate, object, context) {\n  var triple = [];\n  triple[0] = $subject;\n  triple[1] = $predicate;\n  triple[2] = $object;\n  triple[3] = $context;\n\n  return triple;\n}\n\n//----------------------------------------------------------------------------------------\n// Enclose triple in suitable wrapping for HTML display or triplet output\nfunction wrap(s, html) {\n  if (s.match(/^(http|urn|_:)/)) {\n    if (html) {\n      s = '&lt;' + s + '&gt;';\n    } else {\n      s = '<' + s + '>';\n    }\n  } else {\n    s = '\"' + s.replace(/\"/g, '\\\\\"') + '\"';\n  }\n  return s;\n}\n\n//----------------------------------------------------------------------------------------\n// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/\nfunction htmlEntities(str) {\n  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n}\n\n//----------------------------------------------------------------------------------------\nfunction output(doc, triples) {\n    // CouchDB\n    for (var i in triples) {\n      var s = 0;\n      var p = 1;\n      var o = 2;\n\n      var lang = 3;\n\n      var nquads = wrap(triples[i][s], false) \n\t    \t+ ' ' + wrap(triples[i][p], false) \n\t    \t+ ' ' + wrap(triples[i][o], false);\n\t    if (triples[i][lang]) {\n\t    \tnquads += '@' + triples[i][lang];\n\t    }\n\t    \t\n\t    nquads += ' .' + \"\\n\";\n\n\n      emit(doc._id, nquads);\n    }\n}\n\n// geohash.js\n// Geohash library for Javascript\n// (c) 2008 David Troy\n// Distributed under the MIT License\nBITS = [16, 8, 4, 2, 1];\n\nBASE32 = \"0123456789bcdefghjkmnpqrstuvwxyz\";\nNEIGHBORS = {\n  right: {\n    even: \"bc01fg45238967deuvhjyznpkmstqrwx\"\n  },\n  left: {\n    even: \"238967debc01fg45kmstqrwxuvhjyznp\"\n  },\n  top: {\n    even: \"p0r21436x8zb9dcf5h7kjnmqesgutwvy\"\n  },\n  bottom: {\n    even: \"14365h7k9dcfesgujnmqp0r2twvyx8zb\"\n  }\n};\nBORDERS = {\n  right: {\n    even: \"bcfguvyz\"\n  },\n  left: {\n    even: \"0145hjnp\"\n  },\n  top: {\n    even: \"prxz\"\n  },\n  bottom: {\n    even: \"028b\"\n  }\n};\n\nNEIGHBORS.bottom.odd = NEIGHBORS.left.even;\nNEIGHBORS.top.odd = NEIGHBORS.right.even;\nNEIGHBORS.left.odd = NEIGHBORS.bottom.even;\nNEIGHBORS.right.odd = NEIGHBORS.top.even;\n\nBORDERS.bottom.odd = BORDERS.left.even;\nBORDERS.top.odd = BORDERS.right.even;\nBORDERS.left.odd = BORDERS.bottom.even;\nBORDERS.right.odd = BORDERS.top.even;\n\nfunction refine_interval(interval, cd, mask) {\n  if (cd & mask)\n    interval[0] = (interval[0] + interval[1]) / 2;\n  else\n    interval[1] = (interval[0] + interval[1]) / 2;\n}\n\nfunction calculateAdjacent(srcHash, dir) {\n  srcHash = srcHash.toLowerCase();\n  var lastChr = srcHash.charAt(srcHash.length - 1);\n  var type = (srcHash.length % 2) ? 'odd' : 'even';\n  var base = srcHash.substring(0, srcHash.length - 1);\n  if (BORDERS[dir][type].indexOf(lastChr) != -1)\n    base = calculateAdjacent(base, dir);\n  return base + BASE32[NEIGHBORS[dir][type].indexOf(lastChr)];\n}\n\nfunction decodeGeoHash(geohash) {\n  var is_even = 1;\n  var lat = [];\n  var lon = [];\n  lat[0] = -90.0;\n  lat[1] = 90.0;\n  lon[0] = -180.0;\n  lon[1] = 180.0;\n  lat_err = 90.0;\n  lon_err = 180.0;\n\n  for (i = 0; i < geohash.length; i++) {\n    c = geohash[i];\n    cd = BASE32.indexOf(c);\n    for (j = 0; j < 5; j++) {\n      mask = BITS[j];\n      if (is_even) {\n        lon_err /= 2;\n        refine_interval(lon, cd, mask);\n      } else {\n        lat_err /= 2;\n        refine_interval(lat, cd, mask);\n      }\n      is_even = !is_even;\n    }\n  }\n  lat[2] = (lat[0] + lat[1]) / 2;\n  lon[2] = (lon[0] + lon[1]) / 2;\n\n  return {\n    latitude: lat,\n    longitude: lon\n  };\n}\n\nfunction encodeGeoHash(latitude, longitude) {\n  var is_even = 1;\n  var i = 0;\n  var lat = [];\n  var lon = [];\n  var bit = 0;\n  var ch = 0;\n  var precision = 12;\n  geohash = \"\";\n\n  lat[0] = -90.0;\n  lat[1] = 90.0;\n  lon[0] = -180.0;\n  lon[1] = 180.0;\n\n  while (geohash.length < precision) {\n    if (is_even) {\n      mid = (lon[0] + lon[1]) / 2;\n      if (longitude > mid) {\n        ch |= BITS[bit];\n        lon[0] = mid;\n      } else\n        lon[1] = mid;\n    } else {\n      mid = (lat[0] + lat[1]) / 2;\n      if (latitude > mid) {\n        ch |= BITS[bit];\n        lat[0] = mid;\n      } else\n        lat[1] = mid;\n    }\n\n    is_even = !is_even;\n    if (bit < 4)\n      bit++;\n    else {\n      geohash += BASE32[ch];\n      bit = 0;\n      ch = 0;\n    }\n  }\n  return geohash;\n}\n\n\nfunction message(doc) {\n  var triples = [];\n\n  // id for DataItem\n  var cluster_id = 'http://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?' +\n    'db=nucleotide' +\n    'id=' + doc.message.sequence.accession +\n    '&retype=gb' +\n    '&retmode=xml';\n\n  var locality_id = '';\n  var event_id = '';\n  var identification_id = '';\n  var sequence_id = 'http://identifiers.org/insdc/' + doc.message.sequence.accession;\n\n  // item = occurrence\n  var item_id = 'https://www.ncbi.nlm.nih.gov/nuccore/' + doc.message.sequence.accession_version;\n  var identification_id = item_id + '#identification';\n  var occurrence_id = item_id;\n\n\n  triples.push(triple(item_id,\n    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n    'http://rs.tdwg.org/dwc/terms/Occurrence'));\n\n  triples.push(triple(cluster_id,\n    'http://schema.org/item',\n    item_id));\n\n\n  // record level\n  var date = doc.message.create_date.join('-');\n  date = date.replace(/-([0-9])\\b/g, \"-0$1\");\n\n  triples.push(triple(cluster_id,\n    'http://schema.org/dateCreated',\n    date));\n\n  date = doc.message.update_date.join('-');\n  date = date.replace(/-([0-9])\\b/g, \"-0$1\");\n\n\n  triples.push(triple(cluster_id,\n    'http://schema.org/dateModified',\n    date));\n\n  // item level\n  if (doc.message.definition) {\n    triples.push(triple(item_id,\n      'http://schema.org/description',\n      doc.message.definition));\n  }\n  if (doc.message.version) {\n  triples.push(triple(item_id,\n\t\t\t\t'http://schema.org/version',\n\t\t\t\tdoc.message.sequence.accession_version));    \n  }\t\t\n  \n  // Use accession to name occurrence, and add to otherCatalogNumbers\n  triples.push(triple(item_id,\n\t\t  \t\t'http://schema.org/name',\n\t\t  \t\tdoc.message.sequence.accession ));  \t\n  triples.push(triple(item_id,\n\t\t  \t\t'http://rs.tdwg.org/dwc/terms/otherCatalogNumbers',\n\t\t  \t\tdoc.message.sequence.accession ));  \n  triples.push(triple(item_id,\n\t\t  \t\t'http://rs.tdwg.org/dwc/terms/otherCatalogNumbers',\n\t\t  \t\tdoc.message.sequence.accession_version ));  \n\n  if (doc.message.keywords) {\n    for (var i in doc.message.keywords) {\n      triples.push(triple(item_id,\n        'http://schema.org/about',\n        String(doc.message.keywords[i])));\n    }\n  }\n\n  // links\n  if (doc.message.links) {\n    for (var i in doc.message.links) {\n      if (doc.message.links[i].match(/http:\\/\\/bins.boldsystems.org\\/index.php\\/Public_RecordView/)) {\n        triples.push(triple(item_id,\n          'http://schema.org/sameAs',\n          doc.message.links[i]));\n      }\n    }\n  }\n\n\n\n  // identification\n  triples.push(triple(item_id,\n    'http://rs.tdwg.org/dwc/terms/identificationID',\n    identification_id));\n\n  triples.push(triple(identification_id,\n    'http://rs.tdwg.org/dwc/terms/taxonID',\n    'http://identifiers.org/taxonomy/' + doc.message.identification.taxonID));\n\n  triples.push(triple(identification_id,\n    'http://rs.tdwg.org/dwc/terms/scientificName',\n    doc.message.identification.organism));\n\n  triples.push(triple(identification_id,\n    'http://rs.tdwg.org/dwc/terms/higherClassification',\n    doc.message.identification.taxonomy.join('|')));\n\n  if (doc.message.identification.identifiedBy) {\n    triples.push(triple(identification_id,\n      'http://rs.tdwg.org/dwc/terms/identifiedBy',\n      doc.message.identification.identifiedBy));\n\n\n  }\n\n  // occurrence \n  if (doc.message.sample) {\n    if (doc.message.sample.institutionCode) {\n      triples.push(triple(occurrence_id,\n        'http://rs.tdwg.org/dwc/terms/institutionCode',\n        String(doc.message.sample.institutionCode)));\n    }\n    if (doc.message.sample.collectionCode) {\n      triples.push(triple(occurrence_id,\n        'http://rs.tdwg.org/dwc/terms/collectionCode',\n        String(doc.message.sample.collectionCode)));\n    }\n    if (doc.message.sample.catalogNumber) {\n      triples.push(triple(occurrence_id,\n        'http://rs.tdwg.org/dwc/terms/catalogNumber',\n        String(doc.message.sample.catalogNumber)));\n    }\n\n    if (doc.message.sample.otherCatalogNumbers) {\n      for (var j in doc.message.sample.otherCatalogNumbers) {\n        triples.push(triple(occurrence_id,\n          'http://rs.tdwg.org/dwc/terms/otherCatalogNumbers',\n          String(doc.message.sample.otherCatalogNumbers[j])));\n        triples.push(triple(occurrence_id,\n          'http://schema.org/alternateName',\n          String(doc.message.sample.otherCatalogNumbers[j])));\n\n      }\n\n\n    }\n\n    // host (item-level)\n    if (doc.message.sample.host) {\n\n      triples.push(triple(item_id,\n        'http://rs.tdwg.org/dwc/terms/associatedTaxa',\n        String(doc.message.sample.host)));\n    }\n\n\n\n  }\n\n\n\n\n  // sequence\n  triples.push(triple(item_id,\n    'http://rs.tdwg.org/dwc/terms/associatedSequences',\n    'http://identifiers.org/insdc/' + doc.message.sequence.accession));\n\n  if (doc.message.sequence.gene) {\n    for (var i in doc.message.sequence.gene) {\n      triples.push(triple(sequence_id,\n        'http://schema.org/about',\n        String(doc.message.sequence.gene[i])));\n    }\n  }\n\n  if (doc.message.sequence.product) {\n    for (var i in doc.message.sequence.product) {\n      triples.push(triple(sequence_id,\n        'http://schema.org/about',\n        String(doc.message.sequence.product[i])));\n    }\n  }\n\n\n\n\n  // references\n\n  if (doc.message.references) {\n    var n = doc.message.references.length;\n    for (var i = 0; i < n; i++) {\n      var reference_id = '';\n\n      if (doc.message.references[i].pmid) {\n        reference_id = 'http://identifiers.org/pubmed/' + doc.message.references[i].pmid;\n      }\n      if (doc.message.references[i].doi) {\n        reference_id = 'http://identifiers.org/doi/' + doc.message.references[i].doi;\n      }\n\n\n      // We have a GUID\n      if (reference_id != '') {\n        triples.push(triple(item_id,\n          'http://rs.tdwg.org/dwc/terms/associatedReferences',\n          reference_id));\n      } else {\n        // Store actual reference\n        reference_id = item_id + '#reference_' + (i + 1);\n\n        triples.push(triple(item_id,\n          'http://rs.tdwg.org/dwc/terms/associatedReferences',\n          reference_id));\n\n        triples.push(triple(reference_id,\n          'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n          'http://schema.org/CreativeWork'));\n\n        if (doc.message.references[i].title) {\n          triples.push(triple(reference_id,\n            'http://schema.org/name',\n            doc.message.references[i].title));\n        }\n        if (doc.message.references[i].bibliographicCitation) {\n          triples.push(triple(reference_id,\n            'http://purl.org/dc/terms/bibliographicCitation',\n            doc.message.references[i].bibliographicCitation));\n        }\n\n        if (doc.message.references[i].author) {\n\n          var num_authors = doc.message.references[i].author.length;\n          for (var j = 0; j < num_authors; j++) {\n            var author_id = reference_id + '/author_' + (j + 1);\n\n            triples.push(triple(reference_id,\n              'http://schema.org/author',\n              author_id));\n\n            triples.push(triple(author_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/Person'));\n\n            var name = '';\n            if (doc.message.references[i].author[j].given) {\n              triples.push(triple(author_id,\n                'http://schema.org/givenName', // ?\n                doc.message.references[i].author[j].given));\n\n              name += doc.message.references[i].author[j].given;\n            }\n            if (doc.message.references[i].author[j].family) {\n              triples.push(triple(author_id,\n                'http://schema.org/familyName', // ?\n                doc.message.references[i].author[j].family));\n\n              name += ' ' + doc.message.references[i].author[j].family;\n            }\n\n            if (name != '') {\n              triples.push(triple(author_id,\n                'http://schema.org/name', // ?\n                name));\n            }\n\n\n\n\n          }\n\n\n\n\n        }\n\n\n\n\n        if (doc.message.references[i].journal) {\n\n          triples.push(triple(reference_id,\n            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n            'http://schema.org/ScholarlyArticle'));\n\n          triples.push(triple(reference_id,\n            'http://prismstandard.org/namespaces/basic/2.1/publicationName',\n            doc.message.references[i].journal));\n        }\n\n\n        if (doc.message.references[i].volume) {\n          triples.push(triple(reference_id,\n            'http://schema.org/volumeNumber',\n            String(doc.message.references[i].volume)));\n        }\n        if (doc.message.references[i].issue) {\n          triples.push(triple(reference_id,\n            'http://schema.org/issueNumber',\n            String(doc.message.references[i].issue)));\n        }\n        if (doc.message.references[i].pageStart) {\n          triples.push(triple(reference_id,\n            'http://schema.org/pageStart',\n            String(doc.message.references[i].pageStart)));\n        }\n        if (doc.message.references[i].pageEnd) {\n          triples.push(triple(reference_id,\n            'http://schema.org/pageEnd',\n            String(doc.message.references[i].pageEnd)));\n        }\n        if (doc.message.references[i].year) {\n          triples.push(triple(reference_id,\n            'http://schema.org/datePublished',\n            String(doc.message.references[i].year)));\n        }\n\n\n\n      }\n\n    }\n  }\n\n\n\n\n  // event\n  if (doc.message.event) {\n    for (var i in doc.message.event) {\n      switch (i) {\n        case 'verbatimEventDate':\n        case 'eventDate':\n\n          if (event_id == '') {\n            // b-node\n            event_id = item_id + '#event';\n\n            if (doc.message.eventID) {\n              if (doc.message.eventID.match(/^(http[s]?|urn)/)) {\n                event_id = doc.message.eventID;\n              }\n            }\n\n            triples.push(triple(event_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://rs.tdwg.org/dwc/terms/Event'));\n\n            // link to cluster\n            triples.push(triple(item_id,\n              'http://rs.tdwg.org/dwc/terms/eventID',\n              event_id));\n          }\n\n          switch (i) {\n            case 'verbatimEventDate':\n              triples.push(triple(event_id,\n                'http://rs.tdwg.org/dwc/terms/verbatimEventDate',\n                String(doc.message.event[i])));\n              break;\n\n            case 'eventDate':\n              if (doc.message.event[i].length == 3) {\n                triples.push(triple(event_id,\n                  'http://rs.tdwg.org/dwc/terms/day',\n                  String(doc.message.event[i][2])));\n              }\n\n              if (doc.message.event[i].length >= 2) {\n                triples.push(triple(event_id,\n                  'http://rs.tdwg.org/dwc/terms/month',\n                  String(doc.message.event[i][1])));\n              }\n              if (doc.message.event[i].length >= 1) {\n                triples.push(triple(event_id,\n                  'http://rs.tdwg.org/dwc/terms/year',\n                  String(doc.message.event[i][0])));\n              }\n              date = doc.message.event[i].join('-');\n              date = date.replace(/-([0-9])\\b/g, \"-0$1\");\n\n              triples.push(triple(event_id,\n                'http://rs.tdwg.org/dwc/terms/eventDate',\n                date));\n\n              break;\n\n            default:\n              break;\n          }\n\n\n          break;\n\n        default:\n          break;\n      }\n    }\n  }\n\n  // locality\n  if (doc.message.locality) {\n    for (var i in doc.message.locality) {\n      switch (i) {\n        // Darwin Core locality-----------------------------------------------------------\n        case 'country':\n        case 'decimalLatitude':\n        case 'decimalLongitude':\n        case 'locality':\n\n          // b-node (maybe with global identifer)\n          if (locality_id == '') {\n            var geohash = '';\n\n            locality_id = item_id + '#locality';\n            if (doc.message.locality.decimalLatitude && doc.message.locality.decimalLongitude) {\n              geohash = encodeGeoHash(doc.message.locality.decimalLatitude, doc.message.locality.decimalLongitude);\n              locality_id = 'http://geohash.org/' + geohash;\n            }\n\n            // types\n            triples.push(triple(locality_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://purl.org/dc/terms/Location'));\n\n            triples.push(triple(locality_id,\n              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n              'http://schema.org/Place'));\n\n            // link to cluster\n            triples.push(triple(item_id,\n              'http://rs.tdwg.org/dwc/terms/locationID',\n              locality_id));\n\n\n            // Store the geohash\n            if (geohash != '') {\n              triples.push(triple(locality_id,\n                'http://www.w3.org/ns/locn#geometry',\n                'http://geohash.org/' + geohash));\n            }\n\n            if (doc.message.locality.decimalLatitude && doc.message.locality.decimalLongitude) {\n\n              // map\n              var mapUrl = 'http://www.openstreetmap.org/' +\n                '?mlat=' + doc.message.locality.decimalLatitude +\n                '&mlon=' + doc.message.locality.decimalLongitude +\n                '&zoom=8';\n\n              triples.push(triple(locality_id,\n                'http://schema.org/hasMap',\n                mapUrl));\n\n\n              // geo\n              var geo_id = locality_id + '/geo';\n\n              triples.push(triple(locality_id,\n                'http://schema.org/geo',\n                geo_id));\n\n              triples.push(triple(geo_id,\n                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n                'http://schema.org/GeoCoordinates'));\n              triples.push(triple(geo_id,\n                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n                'http://schema.org/GeoCoordinates'));\n              triples.push(triple(geo_id,\n                'http://schema.org/latitude',\n                String(doc.message.locality.decimalLatitude)));\n              triples.push(triple(geo_id,\n                'http://schema.org/longitude',\n                String(doc.message.locality.decimalLongitude)));\n\n            }\n\n          }\n          triples.push(triple(locality_id,\n            'http://rs.tdwg.org/dwc/terms/' + i,\n            String(doc.message.locality[i])));\n          break;\n\n        default:\n          break;\n      }\n    }\n  }\n\n  // defaults\n  triples.push(triple(cluster_id,\n    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',\n    'http://schema.org/DataFeedItem'));\n\n  output(doc, triples);\n\n\n}\n\nfunction(doc) {\n  if (doc['message-format']) {\n    if (doc['message-format'] == 'genbank') {\n      message(doc);\n    }\n  }\n}"
       },
       "modified": {
           "map": "function(doc) {\n  if (doc['message-format']) {\n    if (doc['message-format'] == 'genbank') {\n     if (doc.message) {\n      emit(doc['message-modified'], doc._id);\n     }\n    }\n  }\n}"
       }
   }
}