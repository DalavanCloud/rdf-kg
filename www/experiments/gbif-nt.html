<html>
	<head>
		<title>GBIF dataset to n-triples</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<script src="jsonld.js"></script>
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>GBIF dataset  to n-triples</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>JSON</h2>

<!-- JSON for data object goes below -->
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">
{
	"key": "bfee38ac-d1ef-47d5-b4a3-ffa07cc53f18",
	"installationKey": "7ce8aef1-9e92-11dc-8740-b8a03c50a999",
	"publishingOrganizationKey": "7ce8aef0-9e92-11dc-8738-b8a03c50a862",
	"doi": "doi:10.7717/peerj.2321",
	"external": false,
	"numConstituents": 0,
	"type": "CHECKLIST",
	"title": "Arktocara yakataga, a new fossil odontocete (Mammalia, Cetacea) from the Oligocene of Alaska and the antiquity of Platanistoidea",
	"description": "This dataset contains the digitized treatments in Plazi based on the original journal article Alexandra T. Boersma, Nicholas D. Pyenson (2016): Arktocara yakataga, a new fossil odontocete (Mammalia, Cetacea) from the Oligocene of Alaska and the antiquity of Platanistoidea. Peerj 2321: 1-41, DOI: 10.7717/peerj.2321",
	"language": "eng",
	"homepage": "http://tb.plazi.org/GgServer/summary/1C02814FAF3FFFD1056FFFD3FF93DC0D",
	"citation": {
		"text": "Alexandra T. Boersma, Nicholas D. Pyenson (2016): Arktocara yakataga, a new fossil odontocete (Mammalia, Cetacea) from the Oligocene of Alaska and the antiquity of Platanistoidea. Peerj 2321: 1-41, DOI: 10.7717/peerj.2321"
	},
	"lockedForAutoUpdate": false,
	"createdBy": "plazi",
	"modifiedBy": "crawler.gbif.org",
	"created": "2016-08-24T11:01:25.612+0000",
	"modified": "2016-08-24T15:06:50.592+0000",
	"contacts": [{
		"key": 389734,
		"type": "ORIGINATOR",
		"primary": true,
		"userId": [],
		"lastName": "Nicholas D. Pyenson",
		"position": [],
		"email": [],
		"phone": [],
		"homepage": [],
		"address": [],
		"createdBy": "crawler.gbif.org",
		"modifiedBy": "crawler.gbif.org",
		"created": "2016-08-24T15:06:50.535+0000",
		"modified": "2016-08-24T15:06:50.535+0000"
	}, {
		"key": 389735,
		"type": "ADMINISTRATIVE_POINT_OF_CONTACT",
		"primary": true,
		"userId": [],
		"firstName": "Guido",
		"lastName": "Sautter",
		"position": [],
		"email": ["sautter@ipd.uka.de"],
		"phone": [],
		"homepage": ["http://plazi.org"],
		"address": [],
		"createdBy": "crawler.gbif.org",
		"modifiedBy": "crawler.gbif.org",
		"created": "2016-08-24T15:06:50.543+0000",
		"modified": "2016-08-24T15:06:50.543+0000"
	}, {
		"key": 389736,
		"type": "PUBLISHER",
		"primary": false,
		"userId": [],
		"position": [],
		"email": ["info@plazi.org"],
		"phone": [],
		"homepage": ["http://plazi.org/"],
		"organization": "Plazi",
		"address": [],
		"city": "Bern",
		"country": "CH",
		"createdBy": "crawler.gbif.org",
		"modifiedBy": "crawler.gbif.org",
		"created": "2016-08-24T15:06:50.546+0000",
		"modified": "2016-08-24T15:06:50.546+0000"
	}, {
		"key": 389737,
		"type": "METADATA_AUTHOR",
		"primary": true,
		"userId": [],
		"position": [],
		"email": [],
		"phone": [],
		"homepage": [],
		"organization": "Plazi",
		"address": [],
		"createdBy": "crawler.gbif.org",
		"modifiedBy": "crawler.gbif.org",
		"created": "2016-08-24T15:06:50.548+0000",
		"modified": "2016-08-24T15:06:50.548+0000"
	}],
	"endpoints": [{
		"key": 131395,
		"type": "DWC_ARCHIVE",
		"url": "http://tb.plazi.org/GgServer/dwca/1C02814FAF3FFFD1056FFFD3FF93DC0D.zip",
		"createdBy": "plazi",
		"modifiedBy": "plazi",
		"created": "2016-08-24T11:01:26.205+0000",
		"modified": "2016-08-24T11:01:26.205+0000",
		"machineTags": []
	}],
	"machineTags": [{
		"key": 452206,
		"namespace": "crawler.gbif.org",
		"name": "crawl_attempt",
		"value": "7",
		"createdBy": "crawler.gbif.org",
		"created": "2016-09-01T10:16:45.417+0000"
	}],
	"tags": [],
	"identifiers": [{
		"key": 64217,
		"type": "DOI",
		"identifier": "doi:10.15468/jq8qn4",
		"createdBy": "crawler.gbif.org",
		"created": "2016-08-24T11:02:29.846+0000"
	}, {
		"key": 64216,
		"type": "UUID",
		"identifier": "0194A593-DBE0-47CA-A41F-04A37931BA2F",
		"createdBy": "crawler.gbif.org",
		"created": "2016-08-24T11:02:29.830+0000"
	}, {
		"key": 64215,
		"type": "UUID",
		"identifier": "1C02814FAF3FFFD1056FFFD3FF93DC0D",
		"createdBy": "plazi",
		"created": "2016-08-24T11:01:25.957+0000"
	}],
	"comments": [],
	"bibliographicCitations": [],
	"curatorialUnits": [],
	"taxonomicCoverages": [],
	"geographicCoverages": [],
	"temporalCoverages": [],
	"keywordCollections": [],
	"countryCoverage": [],
	"collections": [],
	"dataDescriptions": [],
	"dataLanguage": "eng",
	"pubDate": "2015-12-31T23:00:00.001+0000",
	"license": "http://creativecommons.org/licenses/by/4.0/legalcode"
}			
			</textarea>
			<br />
			<button onclick="convert()">Convert</button>
		
	
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>Triples</h2>
		<div id="output" style="width:100%;color:#222;"></div>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;"></div>
	</div>

</div>

		<script>
		
		

		
// potentially shared code
function triple($subject, $predicate, $object) {
  var triple = [];
  triple[0] = $subject;
  triple[1] = $predicate;
  triple[2] = $object;
  
  return triple;
}

function quad($subject, $predicate, $object, $context) {
  var triple = [];
  triple[0] = $subject;
  triple[1] = $predicate;
  triple[2] = $object;
  triple[3] = $context;
  
  return triple;
}


function wrap(s, html) {
  if (s.match(/^(http|urn|_:)/)) {
    if (html) {
      s = '&lt;' + s + '&gt;';
    } else {
      s = '<' + s + '>';
    }
  } else {
    s = '"' + s.replace(/"/, '\"') + '"';
  }
  return s;
}

// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/
function htmlEntities(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function output(doc, triples) {
  if (1) {
	  // Output triples
	  
	  var nquads = '';
	  
	  var html = '<table width="100%">';
	  for (var i in triples) {
		var s = 0;
		var p = 1;
		var o = 2;
		// SPO
		//console.log(JSON.stringify(triples[i]));
	
	
	
		//html += '<tr><td>' + wrap(triples[i][s], true) + '</td><td>' + wrap(triples[i][p], true) + '</td><td>' + wrap(triples[i][o], true) + ' .</td></tr>';
	
	    nquads += wrap(triples[i][s], false) + ' ' + wrap(triples[i][p], false) + ' ' + wrap(triples[i][o], false) + ' .' + "\n";
	
	
	  }
	  html += '</table>';
	  
	  html += '<pre>' + htmlEntities(nquads) + '</pre>';
	  
	  $('#output').html(html);
	  
	   // convert RDF to JSON-LD
jsonld.fromRDF(nquads, {format: 'application/nquads'}, function(err, j) {

//  $('#jsonld').html(JSON.stringify(j, null, 2));

// make nice
 var context = {
  "@vocab" : "http://schema.org/",
  
  "identifier" :"http://purl.org/dc/terms/identifier",


  // article
  "volume" : "http://purl.org/ontology/bibo/volume",
  "issue" : "http://purl.org/ontology/bibo/issue",
  "pages" : "http://purl.org/ontology/bibo/pages",

  // identifiers
  
  "DOI" : "http://identifiers.org/doi/",
  "ISSN": "http://www.worldcat.org/issn/",
  "ORCID": "http://orcid.org/",
  "PMID" : "http://identifiers.org/pmid/",
  
  // rdf
  
   "type": "http://www.w3.org/1999/02/22-rdf-syntax-ns#type",
};

jsonld.compact(j, context, function(err, compacted) {
  $('#jsonld').html('<pre>' + JSON.stringify(compacted, null, 2) + '</pre>');
  });
  
  
}); 
  
  
  } else {
      // CouchDB
	  for (var i in triples) {
		var s = 0;
		var p = 1;
		var o = 2;
		//emit([wrap(triples[i][s], false), wrap(triples[i][p], false), wrap(triples[i][o], false)], 1);
	  }
    
    
  }
}

		
function gbif_data(doc) {
  var triples = [];

  var cluster_id = 'urn:uuid:' + doc.key;

  var identifiers = [];


  // get identifiers
  for (var i in doc) {
    switch (i) {

      case 'doi':
        var doi = doc.doi;
        doi = doi.replace(/DOI:\s*/i, '');
        	
        triples.push(triple(cluster_id,
          'http://purl.org/dc/terms/identifier',
          'http://identifiers.org/doi/' + doi));
        break;
 
    /*
        // any alternative ids
      case 'alternative-id':
        for (var j in doc[i]) {
          triples.push(triple(cluster_id,
            'http://purl.org/dc/terms/identifier',
            doc[i][j]));
        }
        break;
    */

      default:
        break;
    }
  }


  // fields
  for (var i in doc) {
    switch (i) {


        // title can be string or array
      case 'title':
        if (Array.isArray(doc[i])) {
          for (var j in citeproc[i]) {
            triples.push(triple(cluster_id,
              'http://schema.org/name',
              doc[i][j]));
          }
        } else {
          triples.push(triple(cluster_id,
            'http://schema.org/name',
            doc[i]));
        }
        break;
        
        // description
      case 'description':
		triples.push(triple(cluster_id,
		  'http://schema.org/description',
		  doc[i]));
        break;
        
        
        // identifiers
      case 'identifiers':
        for (var j in doc[i]) {
          switch (doc[i][j].type) {
          
            case 'DOI':
             var doi = doc[i][j].identifier;
             doi = doi.replace(/DOI:\s*/i, '');
        	
             triples.push(triple(cluster_id,
              'http://purl.org/dc/terms/identifier',
              'http://identifiers.org/doi/' + doi));
              break;
              
            case 'UUID':
              var uuid = doc[i][j].identifier;
              
              // Fomrat nicely (Plazi doesn't)
              if (uuid.match(/-/)) {
              } else {
                // bfee38ac-d1ef-47d5-b4a3-ffa07cc53f18
                uuid = uuid.substring(0, 8) + '-' + uuid.substring(8, 12) + '-' + uuid.substring(12, 16) + '-' + uuid.substring(16, 22) + '-' + uuid.substring(22);
              }
              
              uuid = 'urn:uuid:' + uuid.toLowerCase();
              
              triples.push(triple(cluster_id,
              'http://purl.org/dc/terms/identifier',
               uuid));
             
              break;
            
            default:
              break;
          }
        }
        break;

        // license
      case 'license':
		triples.push(triple(cluster_id,
		  'http://schema.org/license',
		  doc[i]));
        break;

 

      default:
        break;
    }
  }


  // defaults
  triples.push(triple(cluster_id,
    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
    'http://schema.org/Dataset'));

  output(doc, triples);

}
		
			function convert() {
				var jsonld = $('#json').val();
				var doc = JSON.parse(jsonld);
				gbif_data(doc);
				
			
			}
		</script>


</body>
</html>