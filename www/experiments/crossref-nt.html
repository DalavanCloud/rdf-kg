<html>
	<head>
		<title>CrossRef to n-triples</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<script src="jsonld.js"></script>
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>CrossRef to n-triples</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>Mendeley</h2>
		
<!-- {
	"status": "ok",
	"message-type": "work",
	"message-version": "1.0.0",
	"message": {
		"indexed": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T04:41:16Z",
			"timestamp": 1469680876192
		},
		"reference-count": 52,
		"publisher": "Elsevier BV",
		"license": [{
			"content-version": "tdm",
			"delay-in-days": 0,
			"start": {
				"date-parts": [
					[2016, 7, 1]
				],
				"date-time": "2016-07-01T00:00:00Z",
				"timestamp": 1467331200000
			},
			"URL": "http:\/\/www.elsevier.com\/tdm\/userlicense\/1.0\/"
		}, {
			"content-version": "vor",
			"delay-in-days": 20,
			"start": {
				"date-parts": [
					[2016, 7, 21]
				],
				"date-time": "2016-07-21T00:00:00Z",
				"timestamp": 1469059200000
			},
			"URL": "http:\/\/creativecommons.org\/licenses\/by\/4.0\/"
		}],
		"funder": [{
			"award": [],
			"doi-asserted-by": "publisher",
			"name": "Rufford Foundation",
			"DOI": "10.13039\/100007463"
		}, {
			"award": ["SFRH\/BPD\/80726\/2011"],
			"name": "FCT - the Foundation for Science and Technology"
		}, {
			"award": ["1329750"],
			"name": "National Science Foundation Dissertation Improvement Grant"
		}, {
			"award": ["308454"],
			"name": "European Union"
		}, {
			"award": [],
			"name": "US Geological Survey Ecosystem"
		}],
		"published-print": {
			"date-parts": [
				[2016, 7]
			]
		},
		"DOI": "10.1016\/j.biocon.2016.07.014",
		"type": "journal-article",
		"created": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T03:26:08Z",
			"timestamp": 1469676368000
		},
		"source": "CrossRef",
		"title": ["Global biodiversity monitoring: From data sources to Essential Biodiversity Variables"],
		"prefix": "http:\/\/id.crossref.org\/prefix\/10.1016",
		"author": [{
			"affiliation": [],
			"family": "Proen\u00e7a",
			"given": "V\u00e2nia",
			"ORCID": "http:\/\/orcid.org\/0000-0001-8245-357X"
		}, {
			"affiliation": [],
			"family": "Martin",
			"given": "Laura Jane"
		}, {
			"affiliation": [],
			"family": "Pereira",
			"given": "Henrique Miguel"
		}, {
			"affiliation": [],
			"family": "Fernandez",
			"given": "Miguel"
		}, {
			"affiliation": [],
			"family": "McRae",
			"given": "Louise"
		}, {
			"affiliation": [],
			"family": "Belnap",
			"given": "Jayne"
		}, {
			"affiliation": [],
			"family": "B\u00f6hm",
			"given": "Monika"
		}, {
			"affiliation": [],
			"family": "Brummitt",
			"given": "Neil"
		}, {
			"affiliation": [],
			"family": "Garc\u00eda-Moreno",
			"given": "Jaime"
		}, {
			"affiliation": [],
			"family": "Gregory",
			"given": "Richard D."
		}, {
			"affiliation": [],
			"family": "Honrado",
			"given": "Jo\u00e3o Pradinho"
		}, {
			"affiliation": [],
			"family": "J\u00fcrgens",
			"given": "Norbert"
		}, {
			"affiliation": [],
			"family": "Opige",
			"given": "Michael"
		}, {
			"affiliation": [],
			"family": "Schmeller",
			"given": "Dirk S."
		}, {
			"affiliation": [],
			"family": "Tiago",
			"given": "Patr\u00edcia"
		}, {
			"affiliation": [],
			"family": "van Swaay",
			"given": "Chris A.M."
		}],
		"member": "http:\/\/id.crossref.org\/member\/78",
		"container-title": ["Biological Conservation"],
		"link": [{
			"intended-application": "text-mining",
			"content-version": "vor",
			"content-type": "text\/xml",
			"URL": "http:\/\/api.elsevier.com\/content\/article\/PII:S0006320716302786?httpAccept=text\/xml"
		}, {
			"intended-application": "text-mining",
			"content-version": "vor",
			"content-type": "text\/plain",
			"URL": "http:\/\/api.elsevier.com\/content\/article\/PII:S0006320716302786?httpAccept=text\/plain"
		}],
		"deposited": {
			"date-parts": [
				[2016, 7, 28]
			],
			"date-time": "2016-07-28T03:26:12Z",
			"timestamp": 1469676372000
		},
		"score": 1.0,
		"subtitle": [],
		"issued": {
			"date-parts": [
				[2016, 7]
			]
		},
		"alternative-id": ["S0006320716302786"],
		"URL": "http:\/\/dx.doi.org\/10.1016\/j.biocon.2016.07.014",
		"ISSN": ["0006-3207"],
		"subject": ["Ecology, Evolution, Behavior and Systematics", "Nature and Landscape Conservation"]
	}
}	-->
		
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">

{
    "indexed": {
        "date-parts": [
            [
                2015,
                12,
                20
            ]
        ],
        "date-time": "2015-12-20T18:46:55Z",
        "timestamp": 1450637215976
    },
    "reference-count": 125,
    "publisher": "eLife Sciences Organisation, Ltd.",
    "license": [
        {
            "content-version": "vor",
            "delay-in-days": 0,
            "start": {
                "date-parts": [
                    [
                        2015,
                        6,
                        30
                    ]
                ],
                "date-time": "2015-06-30T00:00:00Z",
                "timestamp": 1435622400000
            },
            "URL": "http://creativecommons.org/publicdomain/zero/1.0/"
        },
        {
            "content-version": "am",
            "delay-in-days": 0,
            "start": {
                "date-parts": [
                    [
                        2015,
                        6,
                        30
                    ]
                ],
                "date-time": "2015-06-30T00:00:00Z",
                "timestamp": 1435622400000
            },
            "URL": "http://creativecommons.org/publicdomain/zero/1.0/"
        },
        {
            "content-version": "tdm",
            "delay-in-days": 0,
            "start": {
                "date-parts": [
                    [
                        2015,
                        6,
                        30
                    ]
                ],
                "date-time": "2015-06-30T00:00:00Z",
                "timestamp": 1435622400000
            },
            "URL": "http://creativecommons.org/publicdomain/zero/1.0/"
        }
    ],
    "funder": [
        {
            "award": [],
            "doi-asserted-by": "publisher",
            "name": "Rhodes Scholarships",
            "DOI": "10.13039/501100000697"
        },
        {
            "award": [
                "R01-AI069341",
                "N01-A1-25489",
                "R01-GM08322",
                "RAPIDD program",
                "R01-AI091980"
            ],
            "doi-asserted-by": "publisher",
            "name": "National Institutes of Health",
            "DOI": "10.13039/100000002"
        },
        {
            "award": [
                "#NNX15AF36G"
            ],
            "doi-asserted-by": "publisher",
            "name": "National Aeronautics and Space Administration",
            "DOI": "10.13039/100000104"
        },
        {
            "award": [],
            "doi-asserted-by": "publisher",
            "name": "Biotechnology and Biological Sciences Research Council",
            "DOI": "10.13039/501100000268"
        },
        {
            "award": [
                "#21803"
            ],
            "doi-asserted-by": "publisher",
            "name": "Directorate-General for Research and Innovation",
            "DOI": "10.13039/100004431"
        },
        {
            "award": [
                "ECDC/09/018"
            ],
            "doi-asserted-by": "publisher",
            "name": "European Centre for Disease Prevention and Control",
            "DOI": "10.13039/501100000805"
        },
        {
            "award": [
                "#099872",
                "#095066",
                "Vecnet"
            ],
            "doi-asserted-by": "publisher",
            "name": "Wellcome Trust",
            "DOI": "10.13039/100004440"
        },
        {
            "award": [
                "#OPP1053338",
                "#OPP52250"
            ],
            "doi-asserted-by": "publisher",
            "name": "Bill and Melinda Gates Foundation",
            "DOI": "10.13039/100000865"
        },
        {
            "award": [],
            "doi-asserted-by": "publisher",
            "name": "Studienstiftung des Deutschen Volkes",
            "DOI": "10.13039/501100004350"
        },
        {
            "award": [],
            "name": "Sir Richard Southwood Graduate Scholarship"
        }
    ],
    "content-domain": {
        "domain": [],
        "crossmark-restriction": false
    },
    "short-container-title": [],
    "DOI": "10.7554/elife.08347",
    "type": "journal-article",
    "created": {
        "date-parts": [
            [
                2015,
                6,
                30
            ]
        ],
        "date-time": "2015-06-30T11:31:32Z",
        "timestamp": 1435663892000
    },
    "source": "CrossRef",
    "title": " The global distribution of the arbovirus vectors Aedes aegypti and Ae. albopictus ",
    "prefix": "http://id.crossref.org/prefix/10.7554",
    "volume": "4",
    "author": [
        {
            "affiliation": [],
            "family": "Kraemer",
            "given": "Moritz UG"
        },
        {
            "affiliation": [],
            "family": "Sinka",
            "given": "Marianne E"
        },
        {
            "affiliation": [],
            "family": "Duda",
            "given": "Kirsten A"
        },
        {
            "affiliation": [],
            "family": "Mylne",
            "given": "Adrian QN"
        },
        {
            "affiliation": [],
            "family": "Shearer",
            "given": "Freya M"
        },
        {
            "affiliation": [],
            "family": "Barker",
            "given": "Christopher M",
            "ORCID": "http://orcid.org/0000-0002-7941-346X"
        },
        {
            "affiliation": [],
            "family": "Moore",
            "given": "Chester G"
        },
        {
            "affiliation": [],
            "family": "Carvalho",
            "given": "Roberta G"
        },
        {
            "affiliation": [],
            "family": "Coelho",
            "given": "Giovanini E"
        },
        {
            "affiliation": [],
            "family": "Van Bortel",
            "given": "Wim"
        },
        {
            "affiliation": [],
            "family": "Hendrickx",
            "given": "Guy"
        },
        {
            "affiliation": [],
            "family": "Schaffner",
            "given": "Francis",
            "ORCID": "http://orcid.org/0000-0001-9166-7617"
        },
        {
            "affiliation": [],
            "family": "Elyazar",
            "given": "Iqbal RF"
        },
        {
            "affiliation": [],
            "family": "Teng",
            "given": "Hwa-Jen"
        },
        {
            "affiliation": [],
            "family": "Brady",
            "given": "Oliver J"
        },
        {
            "affiliation": [],
            "family": "Messina",
            "given": "Jane P"
        },
        {
            "affiliation": [],
            "family": "Pigott",
            "given": "David M",
            "ORCID": "http://orcid.org/0000-0002-6731-4034"
        },
        {
            "affiliation": [],
            "family": "Scott",
            "given": "Thomas W"
        },
        {
            "affiliation": [],
            "family": "Smith",
            "given": "David L",
            "ORCID": "http://orcid.org/0000-0003-4367-3849"
        },
        {
            "affiliation": [],
            "family": "Wint",
            "given": "GR William"
        },
        {
            "affiliation": [],
            "family": "Golding",
            "given": "Nick",
            "ORCID": "http://orcid.org/0000-0001-8916-5570"
        },
        {
            "affiliation": [],
            "family": "Hay",
            "given": "Simon I",
            "ORCID": "http://orcid.org/0000-0002-0611-7272"
        }
    ],
    "member": "http://id.crossref.org/member/4374",
    "published-online": {
        "date-parts": [
            [
                2015,
                6,
                30
            ]
        ]
    },
    "container-title": "eLife",
    "original-title": [],
    "link": [
        {
            "intended-application": "text-mining",
            "content-version": "vor",
            "content-type": "application/pdf",
            "URL": "http://elifesciences.org/lookup/doi/10.7554/eLife.08347"
        }
    ],
    "deposited": {
        "date-parts": [
            [
                2015,
                7,
                7
            ]
        ],
        "date-time": "2015-07-07T10:29:38Z",
        "timestamp": 1436264978000
    },
    "score": 1,
    "subtitle": [],
    "short-title": [],
    "issued": {
        "date-parts": [
            [
                2015,
                6,
                30
            ]
        ]
    },
    "alternative-id": [
        "10.7554/eLife.08347"
    ],
    "URL": "http://dx.doi.org/10.7554/elife.08347",
    "archive": [
        "CLOCKSS"
    ],
    "ISSN": [
        "2050-084X"
    ]
}		
			</textarea>
			<br />
			<button onclick="convert()">Convert</button>
		
	
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>Triples</h2>
		<div id="output" style="width:100%;color:#222;"></div>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;"></div>
		<div id="extra" style="width:100%;"></div>

	
	</div>

</div>

		<script>
		
		

		
// potentially shared code
function triple($subject, $predicate, $object) {
  var triple = [];
  triple[0] = $subject;
  triple[1] = $predicate;
  triple[2] = $object;
  
  return triple;
}

function quad($subject, $predicate, $object, $context) {
  var triple = [];
  triple[0] = $subject;
  triple[1] = $predicate;
  triple[2] = $object;
  triple[3] = $context;
  
  return triple;
}


function wrap(s, html) {
  if (s.match(/^(http|urn|_:)/)) {
    if (html) {
      s = '&lt;' + s + '&gt;';
    } else {
      s = '<' + s + '>';
    }
  } else {
    s = '"' + s.replace(/"/, '\"') + '"';
  }
  return s;
}

// https://css-tricks.com/snippets/javascript/htmlentities-for-javascript/
function htmlEntities(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function output(doc, triples) {
  if (1) {
	  // Output triples
	  
	  var nquads = '';
	  
	  var html = '<table width="100%">';
	  for (var i in triples) {
		var s = 0;
		var p = 1;
		var o = 2;
		// SPO
		//console.log(JSON.stringify(triples[i]));
	
	
	
		//html += '<tr><td>' + wrap(triples[i][s], true) + '</td><td>' + wrap(triples[i][p], true) + '</td><td>' + wrap(triples[i][o], true) + ' .</td></tr>';
	
	    nquads += wrap(triples[i][s], false) + ' ' + wrap(triples[i][p], false) + ' ' + wrap(triples[i][o], false) + ' .' + "\n";
	
	
	  }
	  html += '</table>';
	  
	  html += '<pre>' + htmlEntities(nquads) + '</pre>';
	  
	  $('#output').html(html);
	  
	   // convert RDF to JSON-LD
jsonld.fromRDF(nquads, {format: 'application/nquads'}, function(err, j) {

//  $('#jsonld').html(JSON.stringify(j, null, 2));

// make nice
 var context = {
  "@vocab" : "http://schema.org/",
  
  "identifier" :"http://purl.org/dc/terms/identifier",
//  "title" : "http://purl.org/dc/terms/title",


  "volume" : "http://purl.org/ontology/bibo/volume",
  "issue" : "http://purl.org/ontology/bibo/issue",
  "pages" : "http://purl.org/ontology/bibo/pages",

  
  "DOI" : "http://identifiers.org/doi/",
  "ISSN": "http://www.worldcat.org/issn/",
  "ORCID": "http://orcid.org/",
  "PMID" : "http://identifiers.org/pmid/",
  
  
  
   "type": "http://www.w3.org/1999/02/22-rdf-syntax-ns#type",
};

jsonld.compact(j, context, function(err, compacted) {
  $('#jsonld').html('<pre>' + JSON.stringify(compacted, null, 2) + '</pre>');
  });
  
  
}); 
  
  
  } else {
      // CouchDB
	  for (var i in triples) {
		var s = 0;
		var p = 1;
		var o = 2;
		//emit([wrap(triples[i][s], false), wrap(triples[i][p], false), wrap(triples[i][o], false)], 1);
	  }
    
    
  }
}

		
function citeproc(doc) {
  var triples = [];

  var cluster_id = '';

  var identifiers = [];

  // CiteProc format data 
  var citeproc = doc;

  // If via CrossRef API then it's wrapped in a message
  if (doc.message) {
    citeproc = doc.message;
  }

  // get identifiers
  for (var i in citeproc) {
    switch (i) {

      case 'DOI':
        var cluster_id = 'http://identifiers.org/doi/' + citeproc[i];

        triples.push(triple(cluster_id,
          'http://purl.org/dc/terms/identifier',
          'http://identifiers.org/doi/' + citeproc[i]));
        break;

        // any alternative ids
      case 'alternative-id':
        for (var j in citeproc[i]) {
          triples.push(triple(cluster_id,
            'http://purl.org/dc/terms/identifier',
            citeproc[i][j]));
        }
        break;

      default:
        break;
    }
  }


  // fields
  for (var i in citeproc) {
    switch (i) {

      case 'type':
        switch (citeproc[i]) {
          case 'journal-article':
            triples.push(triple(cluster_id,
              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
              'http://schema.org/ScholarlyArticle'));
            break;
          default:
            break;
        }
        break;

        // title can be string or array
      case 'title':
        if (Array.isArray(citeproc[i])) {
          for (var j in citeproc[i]) {
            triples.push(triple(cluster_id,
              'http://schema.org/name',
              citeproc[i][j]));
          }
        } else {
          triples.push(triple(cluster_id,
            'http://schema.org/name',
            citeproc[i]));
        }
        break;

        // article metadata
      case 'issue':
        triples.push(triple(cluster_id,
          'http://schema.org/issueNumber',
          citeproc[i]));
        break;

      case 'pages':
        triples.push(triple(cluster_id,
          'http://schema.org/pagination',
          citeproc[i]));
        break;

      case 'volume':
        triples.push(triple(cluster_id,
          'http://schema.org/volumeNumber',
          citeproc[i]));
        break;

        // journal
      case 'ISSN':
        for (var j in citeproc[i]) {
          var journal_id = 'http://www.worldcat.org/issn/' + citeproc[i][j];
          triples.push(triple(cluster_id,
            'http://schema.org/isPartOf',
            journal_id
          ));

          // type
          triples.push(triple(journal_id,
            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
            'http://schema.org/Periodical'));

          // issn
          triples.push(triple(journal_id,
            'http://schema.org/issn',
            citeproc[i][j]));

          // journal name can be string or array
          if (Array.isArray(citeproc['container-title'])) {
            for (var j in citeproc['container-title']) {
              triples.push(triple(journal_id,
                'http://schema.org/name',
                citeproc['container-title'][j]));
            }
          } else {
            triples.push(triple(journal_id,
              'http://schema.org/name',
              citeproc['container-title']));
          }

        }
        break;

        // authors (may include ORCIDs)
        // if no ORCID then we have a bnode, so create an identifier to make this addressable
      case 'author':
        var n = citeproc[i].length;
        for (var j = 0; j < n; j++) {
          var author_id = '';

          // create identifier
          if (citeproc[i][j].ORCID) {
            author_id = citeproc[i][j].ORCID;
          } else {
            // #hash identifier 
            author_id = cluster_id + '#author_' + (j + 1);
          }

          // type, need to handle organisations as authors
          triples.push(triple(author_id,
            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
            'http://schema.org/Person'));

          triples.push(triple(cluster_id,
            'http://schema.org/author',
            author_id));

          // name
          var name = '';
          if (citeproc[i][j].given) {
            triples.push(triple(author_id,
              'http://schema.org/givenName', // ?
              citeproc[i][j].given));

            name += citeproc[i][j].given;
          }
          if (citeproc[i][j].family) {
            triples.push(triple(author_id,
              'http://schema.org/familyName', // ?
              citeproc[i][j].family));

            name += ' ' + citeproc[i][j].family;
          }

          if (name != '') {
            triples.push(triple(author_id,
              'http://schema.org/name', // ?
              name));
          }
          
          // affiliation
          // eventually this should be a role because
          // people can change their affiliation
         if (citeproc[i][j].affiliation) {            
            for (var k in citeproc[i][j].affiliation) {
               if (citeproc[i][j].affiliation[k].name) {
                 triples.push(triple(author_id,
                  'http://schema.org/affiliation', 
                  citeproc[i][j].affiliation[k].name));
               }
             }
          }
         

        }
        break;

        // publisher
        // should this be linked to journal rather than article?
      case 'publisher':
        triples.push(triple(cluster_id,
          'http://schema.org/publisher',
          citeproc[i]));
        break;

        // funding
      case 'funder':
        var n = citeproc[i].length;
        for (var j = 0; j < n; j++) {
          var funder_id = '';

          // create identifier for funder
          if (citeproc[i][j].DOI) {
            funder_id = 'http://identifiers.org/doi/' + citeproc[i][j].DOI;
          } else {
            // #hash identifier 
            funder_id = cluster_id + '#funder_' + (j + 1);
          }

          // create funder 
          triples.push(triple(funder_id,
            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
            'http://schema.org/Organisation'));

          triples.push(triple(funder_id,
            'http://schema.org/name',
            citeproc[i][j].name));

          // role
          var m = citeproc[i][j].award.length;

          if (m == 0) {
            // funder but award not known
            var award_id = funder_id + '/award';

            triples.push(triple(award_id,
              'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
              'http://schema.org/Role'));

            // link to funder 
            triples.push(triple(award_id,
              'http://schema.org/funder',
              funder_id));

            // link role to work         
            triples.push(triple(cluster_id,
              'http://schema.org/funder',
              award_id));
          } else {
            // we have one or more awards
            for (var a = 0; a < m; a++) {
              var award_id = funder_id + '/award' + a;

              triples.push(triple(award_id,
                'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
                'http://schema.org/Role'));

              triples.push(triple(award_id,
                'http://schema.org/roleName',
                citeproc[i][j].award[a]
              ));

              // link to funder 
              triples.push(triple(award_id,
                'http://schema.org/funder',
                funder_id));

              // link role to work         
              triples.push(triple(cluster_id,
                'http://schema.org/funder',
                award_id));
            }
          }
        }
        break;

        // license
      case 'license':
        for (var j in citeproc[i]) {
          if (citeproc[i][j].URL) {
            triples.push(triple(cluster_id,
              'http://schema.org/license',
              citeproc[i][j].URL));
          }
        }
        break;

        // links to representions such as PDFs, XML, HTML, etc.
        // may be links to text mining sources
      case 'link':
        var n = citeproc[i].length;
        for (var j = 0; j < n; j++) {
          var link_id = cluster_id + '#link_' + (j + 1);

          // type
          triples.push(triple(link_id,
            'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
            'http://schema.org/CreativeWork'));

          if (citeproc[i][j].URL) {
            triples.push(triple(link_id,
              'http://schema.org/url',
              citeproc[i][j].URL));

            if (citeproc[i][j]['content-type']) {
              triples.push(triple(link_id,
                'http://schema.org/fileFormat',
                citeproc[i][j]['content-type']));
            }

            // link to work
            triples.push(triple(cluster_id,
              'http://schema.org/workExample',
              link_id));
          }
        }
        break;

        // tags
      case 'subject':
        for (var j in citeproc[i]) {
          triples.push(triple(cluster_id,
            'http://schema.org/about',
            citeproc[i][j]));
        }
        break;

      default:
        break;
    }
  }


  // defaults
  triples.push(triple(cluster_id,
    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type',
    'http://schema.org/CreativeWork'));

  output(doc, triples);

}
		
			function convert() {
				var jsonld = $('#json').val();
				var doc = JSON.parse(jsonld);
				citeproc(doc);
				
			
			}
		</script>


</body>
</html>